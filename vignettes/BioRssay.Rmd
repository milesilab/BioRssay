---
title: "BioRssay"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{BioRssay}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(BioRssay)
```

# **An R package for analyses of bioassays and probid graphs**
*Piyal Karunarathne, Pascal Milesi, Nicolas Pocquet, and Pierrick Labb√©*


This package is designed to analyze mortality data from bioassays of one or several strains/lines/populations.
As of now, the functions in the package allow control mortality with Abott's correction for more precise analysis of mortality. For each strain, functions are available to generate mortality-dose regression using a generalized linear model (takes over-dispersion into account and allows mortality of 0 or 1), and plot the regressions with or without the desired confidence interval (e.g. 95%).
The package also carries functions to test the validity of the regression outputs using a chi-square test between model predictions and observed number of dead samples; A significant valid test will reflect a non-linear data (e.g. mixed populations). These plots can be drawn side by side for a better comparison with the same functions (see below).
The functions in the package also compute the lethal dose for 50% and 95% of the populations (LD50 and LD95 respectively), with their 95% confidence intervals (CI), using a methodology described by Johnson et al. 2013, which allows taking the heterogeneity of the data into account (Finney 1971) to calculate the CI (i.e. a larger heterogeneity will increase the CI).
The methods implemented use a likelihood ratio test (LRT) to test coherence of mortality-dose regressions among different strains. In the case of more than two strains, a pairwise comparison of models is performed and further corrected using a sequential Bonferroni correction (Hommel 1988).
Finally, users can calculate the resistance ratios (RR) at LD50 and LD95, i.e. the ratios between a given strain and the starain with the lower LD50 and LD95, respectively (usually it is the susceptible reference), with their 95% confidence intervals, calculated according to Robertson and Preisler (1992).

# 1. **DATA PREPARATION**
BioRssay can import data in any format that is compatible with base R data import functions (e.g. read.table, read.csv). However, for the functions in BioRssay to work, the data **must** have the following columns
        * strain: a column containing the strains tested
        * dose: dosage tested on each strain/sample. controls should be entered as 0
        * total: total number of samples tested
        * dead: number of dead samples
See the examples below.

**Example 1**
```{r}
data(bioassay)
head(bioassay$assay2)
```
Also download the test data at <https://github.com/milesilab/BioRssay/blob/main/inst/Test.BioRssay.txt>

**Example 2**
```{r}
file <- paste0(path.package("BioRssay"), "/Test.BioRssay.txt") # if the download doesn't work
test<-read.table(file,header=TRUE)
head(test)
```
NOTE: It is also possible to include a reference strain/population with the suffix "ref" in the strain column, or the reference strain can be specified later in the function "resist.ratio" to obtain the resistance ratios for each strain (see below).

# 2. **Analysis**

## **Example 1**
Let's have a quick look at the data again.
```{r}
assays<-bioassay
exm1<-assays$assay2
head(exm1)
unique(unique(exm1$strain))
```
This example contains the mortality data of three strains (KIS, DZOU, and KIS-ref); KIS is used as the reference with suffix "ref". 

The first step is to check if the controls also have considerable mortality and whether a correction should be applied to the data, followed by probid transformation (*we might need to explain more on why this transformation*). This is easily achieved with the function "probit.trans".
```{r}
dataT<-probid.trans(exm1) #additionally confindence interval for controls' mortality can be set as desired with "conf="; default is 0.05.
dataT$convrg
head(dataT$tr.data)

```
The output of probid.trans is a list of which the first element (convrg) contains the results of Abotte's correction and convergence values. However, since the mortality in the controls (dose=0) is below 5% (alpha=0.05), no correction applied to the data. Hence data$convrg is NULL. The second element of the list dataT is the probid transformed data with two additional columns: mort: mortality and probmort: probid transformed mortality. This data frame is what we'll use in the next steps of the analysis.

Next we will get the LD values at (50% and 95%) and resistance ratios at their respective LD values. The function "resist.ratio" allows you to do just that. Here you can also change the confidence level at which the LD is tested (default is 0.95); the reference strain can be specified in "ref.strain=", if labeled with the suffix "ref" (as mentioned above), it is not necessary to specify it here although doing so still works. However, if the strain is not labeled with the said suffix in the data, ref.strain **must** be specified here. If neither labeled with "ref" nor specified with "ref.strain=", the analysis will not consider any references.

```{r}
data<-dataT$tr.data #probid transformed data
RR<-resist.ratio(data)
RR
```
*Note that we did not specify the reference strain here as it is already labeled in the data*

  *For each strain you have first the LD50 and LD95 and their upper and lower limits (95% CI), then the slope and intercept of the regression (with their standard error), the heterogeneity (h) and the g factor ("With almost all good sets of data, g will be substantially smaller than 1.0 and seldom greater than 0.4." Finney, 1971).
  *The result of the chi test (Chi(p)) is then indicated to judge whether the data are well fitted to the regression or not: here all the p-values are over 0.05 so the fits are acceptable).
  *Finally the resistance ratios are indicated for LD50 and LD95 (RR50 and RR95).
  *As there are 3 strains, the script first tests whether they are all similar (i.e. equivalent to 1 strain) or not (3 strains vs 1 strain). Here, the test is highly significant, some strains are thus different in terms of resistance.

Plotting option with confidence levels and a validity test of the regression models is also available in the function "resist.ratio". However, we did not use it here and we will do a more comparative plotting with "mort.plot" next.


```{r,fig.dim=c(8,4)}
par(mfrow=c(1,2)) # set plot rows
mort.plot(data,plot.conf=FALSE,test.validity=FALSE) # plot without confidence intervals and test of validity of the model
mort.plot(data,plot.conf=FALSE,test.validity=FALSE,pch=NA) # plot only the regression lines
# same plots with confidence level
par(mfrow=c(1,2))
mort.plot(data,plot.conf=TRUE,test.validity=FALSE)
mort.plot(data,plot.conf=TRUE,test.validity=FALSE,pch=NA)
```
It is also possible to input different confidence levels with "conf.level=". The default is 0.95. In cases where only a subset of all the tested strains needs to be tested, they can be listed with "strains="; if not provided, all the strains will be plotted.


## **Example 2**
We follow the same workflow the example 2. However, there are more than one insecticide tested in this experiment. Therefore, we need to subset the data into separate insecticides and carry out the analysis as before.

```{r}
head(test)
unique(test$insecticide)
bend<-test[test$insecticide=="bendiocarb",]
head(bend)
```
We have a subset of the data with only the insecticide "bendiocarb"

```{r,fig.dim=c(6,4)}
dataT.b<-probid.trans(bend)
data.b<-dataT.b$tr.data

RR.b<-resist.ratio(data.b,plot = T,ref.strain = "Kisumu",plot.conf = T, test.validity = T)
head(RR.b)
```
Note that we have enabled the arguments "plot=" with "plot.conf=" and "test.validity=". When the regression is not valid (Chi-square significance) for a strain, it will be plotted without the regression, as in this example "Kisumu".

```{r}
#test the validity of the regression models
t.models<-model.signif(data.b)
t.models
```

These steps can be repeated for separate insecticides in the example 2 one by one or in a loop (e.g. for loop)


# 3. **REFERENCES**
  1. Finney DJ(1971). Probitanalysis. Cambridge:Cambridge UniversityPress. 350p.
  
  1. HommelG(1988). A stage wise rejective multiple test procedure based on a modified Bonferroni test. Biometrika 75, 383-6.
  
  1. Johnson RM, Dahlgren L, Siegfried BD,EllisMD(2013). Acaricide,fungicide and druginteractions in honeybees (Apis mellifera). PLoSONE8(1): e54092.
  
  1. Robertson, J. L., and H.K. Preisler.1992. Pesticide bioassays with arthropods. CRC, Boca Raton, FL.











